# GPX Viewer

<br>

シンプルな GPX ビューアです。

GPXファイルに `time` 要素がある場合は時間スライダで現在位置を再生できます。

<br><br>

## ライブデモ（GitHub Pages）

- https://takamitsu-iida.github.io/gpx-viewer/

<br><br>

## できること

- GPX（`trkpt`/`rtept`）の読み込みと軌跡表示
- 移動速度による軌跡の色付け
- `time` ありの場合：時間スライダで現在位置（マーカー）を移動・再生
- 区間選択（開始〜終了）と、選択区間のハイライト表示
- UI下の情報表示
  - 開始から終了までの距離
  - 開始から終了までの時間
  - 平均移動速度（ノット/時）
  - GPS座標（現在位置）
- 潮汐グラフの表示
- 画像出力（地図領域のみをPNG保存）

<br><br>

## 使い方

### 1) ローカルで起動

ES Modules の読み込みや `fetch()` を安定させるため、簡易サーバで起動するのを推奨します。

```bash
cd gpx-viewer
python3 -m http.server 8000
```

ブラウザで以下を開きます。

- http://localhost:8000/

### 2) GPXを表示

右側サイドバーの UI から操作します。

- **デモ**：同梱サンプル（`data/kaichouzuV_route_14_20260214_205630.gpx`）を読み込みます
- **ファイル選択**：手元の `.gpx` を選択して読み込みます

### 3) 時間スライダ（`time` ありGPXのみ）

- 「区間選択」で開始/終了を動かすと、選択区間が太線でハイライトされます
- 「再生」で現在位置が時間に沿って移動します
- 情報パネルは、選択区間と現在位置に連動して更新されます

### 4) 画像出力（SNS/釣果報告向け）

SNSやブログ等で使いやすいように、画像として保存できます。

右側サイドバーの「画面サイズ」内にある「画像保存」（9:16 の横）で、地図領域（選択区間＋潮汐を含む）をPNGとして保存します。

保存画像には、地図上の小さな透過ラベル（日時・距離・平均速度）が焼き込まれます。

<br><br>

## ディレクトリ構成

- `index.html`：エントリ
- `static/site/js/index.js`：メインロジック（GPX解析、UI、時間スライダ、統計表示）
- `static/site/css/style.css`：スタイル（地図/サイドバー分離レイアウト、UI/情報パネル）
- `data/`：デモ用GPX、最近傍の港を探すためのデータ
- `data/roots.geojson`：根（reef等）の下書きデータ（任意・手動編集用）
- `tools/fetch_roots_overpass.py`：Overpass API から根データを取得して `data/roots.geojson` を生成

<br><br>

## 根（reef等）データ（Overpass/OSM）

東京湾・相模湾の `natural=reef` などを Overpass API 経由で取得し、`data/roots.geojson` に保存できます。

```bash
python3 tools/fetch_roots_overpass.py --out data/roots.geojson
```

> [!NOTE]
>
> OpenStreetMap 由来データ（ODbL）のため、公開時は帰属表示などのライセンス条件に注意してください。

<br><br>

## 地図表示について

地図表示はLeaflet、OpenStreetMapを利用させていただいてます。

感謝致します。

<br><br>

## 潮汐データについて

[日本沿岸736港の潮汐表](https://tide736.net/) を利用させていただいてます。

感謝致します。

<br>

> [!NOTE]
>
> 現在は、GPX の座標（代表点）から **最近傍の港（pc/hc）を自動選択**して潮汐を表示します。
> 取得に失敗した場合はフォールバックとして **神奈川県（pc=14）・油壷（hc=16）** を使います。
>

<br>

### 最近傍の港（pc/hc）の選び方

潮汐表示に使う港は、同梱の港一覧 `data/code.csv`（約736港・緯度/経度つき）から、GPX の座標に最も近い港を 1つ選んで決めています。

選定手順は次のとおりです。

1. **GPX の代表点を決める**
   - GPX の全点（lat/lon）の中央値（median）を代表点として採用します（外れ値の影響を受けにくくするため）。
   - 中央値が作れない場合は先頭点を使います。
2. **港一覧を読み込む（初回のみ）**
   - `data/code.csv` を `fetch()` して港配列に変換し、以降はキャッシュします。
3. **最近傍港を全探索で求める**
   - 代表点と全港の距離を Haversine（球面上の距離）で計算し、最小の港を採用します。
   - 距離計算は基本的に全港ぶん行うため計算量は $O(N)$ です（港が 700件台なので実用上は十分軽い想定です）。
4. **`tideType`（潮汐種別）で type=1 を優先（同一 pc 内）**
   - `code.csv` の「潮汐種別（tideType）」を使い、いったん選ばれた港の **都道府県コード（pc）内**で `tideType=1` の港が存在する場合は、
     そのサブセットでもう一度最近傍を取り直し、`tideType=1` を優先します。

#### `tideType`（1/2）について

`code.csv` の「潮汐種別」は tide736 API のレスポンスにも `tide_type` として含まれており、このアプリでは **type=1 を優先するためのヒント**として使っています。

なお、type=1 / type=2 の公式な定義はこのリポジトリ内には記載していませんが、API レスポンス上は `calc_way`（計算方法）の表記が type によって異なることがあり、
type=1 の港を優先することで “基準となる港” に寄せる意図があります。

<br>

<!--

Tide API（tide736 API）
「日本沿岸736港の潮汐表」を計算・配信している個人サイトのAPIサービス。

APIのURL
https://tide736.net/api/get_tide.php

pc=県のコード 14で固定(神奈川県)
hc=港コード 16で固定(油壷)
yr=年
mn=月
dy=日
rg=期間 dayで固定

例：2026年2月16日の場合
https://tide736.net/api/get_tide.php?pc=14&hc=16&yr=2026&mn=2&dy=16&rg=day





-->